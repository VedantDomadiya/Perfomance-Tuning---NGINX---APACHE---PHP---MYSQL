# MySQL/MariaDB Performance Tuning
# Save this as /etc/mysql/conf.d/performance_tuning.cnf
# Then restart MySQL: sudo systemctl restart mysql

[mysqld]
###############################################################################
# 1) General Settings
###############################################################################
bind-address            = 0.0.0.0      # Allow remote if needed; otherwise keep 127.0.0.1
skip-name-resolve                       # Faster connections (disable DNS lookups)
max_connections         = 150          # Adjust based on app usage
connect_timeout         = 10
wait_timeout            = 60
interactive_timeout     = 60
# New setting to prevent issues with long-running batch jobs.
max_allowed_packet      = 16M          # Increase if you have large BLOB fields

###############################################################################
# 2) InnoDB Engine (Default Storage Engine in MySQL 5.7+/MariaDB 10+)
###############################################################################
default_storage_engine  = InnoDB
innodb_buffer_pool_size = 256M        # ~70% of RAM for dedicated DB server; lower for t2.micro
innodb_buffer_pool_instances = 1      # Increase for >1GB buffer pool
innodb_log_file_size    = 64M
innodb_flush_log_at_trx_commit = 2    # 1 = safest, 2 = better perf, acceptable durability trade-off
innodb_flush_method     = O_DIRECT
innodb_file_per_table   = 1
# New settings for improved I/O and concurrency.
innodb_io_capacity      = 200          # Start with 200 for SSDs, higher for NVMe
innodb_read_io_threads  = 4            # Adjust based on the number of CPU cores
innodb_write_io_threads = 4            # Adjust based on the number of CPU cores
innodb_thread_concurrency = 0          # Let InnoDB manage concurrency (0 for default)

###############################################################################
# 3) Temporary Tables / Sort Buffers
###############################################################################
tmp_table_size          = 64M
max_heap_table_size     = 64M
sort_buffer_size        = 4M
join_buffer_size        = 4M
read_buffer_size        = 2M
read_rnd_buffer_size    = 4M

###############################################################################
# 4) Thread & Query Settings
###############################################################################
thread_cache_size       = 50
table_open_cache        = 400
open_files_limit        = 65535
# New setting to control the number of tables that can be cached.
table_definition_cache  = 400          # Can be increased if you have a large number of tables.

###############################################################################
# 5) Slow Query Logging
###############################################################################
slow_query_log          = 1
slow_query_log_file     = /var/log/mysql/mysql-slow.log
long_query_time         = 1
log_queries_not_using_indexes = 1

###############################################################################
# 6) Binary Logging (enable if replication needed)
###############################################################################
# log_bin               = /var/log/mysql/mysql-bin.log
# server_id             = 1
# expire_logs_days      = 7
# sync_binlog           = 1

###############################################################################
# 7) Security Hardening
###############################################################################
symbolic-links=0
local-infile=0

###############################################################################
# 8) Query Cache (DEPRECATED in MySQL 8, still in MariaDB)
###############################################################################
# query_cache_type      = 1
# query_cache_size      = 32M

###############################################################################
# 9) New Settings from Best Practices
###############################################################################
# Set the default character set and collation
character-set-server  = utf8mb4
collation-server      = utf8mb4_unicode_ci

# Explicitly set the temporary directory
tmpdir                = /tmp

# MyISAM specific settings (even if not the default, some system tables may use it)
key_buffer_size       = 16M
