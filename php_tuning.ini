; PHP Performance & Hardening
; Save as /etc/php/8.2/fpm/conf.d/90-tuning.ini
; Then restart: sudo systemctl restart php8.2-fpm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; 1) Resource Limits
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
memory_limit = 256M
max_execution_time = 60
max_input_time = 60
; Tweak: Set post_max_size slightly larger than upload_max_filesize
; to account for other POST data besides the file itself.
post_max_size = 35M
upload_max_filesize = 32M
max_input_vars = 3000

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; 2) OPcache - The single most important performance booster
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
[opcache]
opcache.enable = 1
opcache.enable_cli = 1
opcache.memory_consumption = 128
opcache.interned_strings_buffer = 16
opcache.max_accelerated_files = 10000

; Production Tweak: Disable timestamp validation for maximum performance.
; PHP will no longer check if a file has been changed.
; **IMPORTANT**: You MUST restart/reload PHP-FPM after every code deployment.
opcache.validate_timestamps = 0
; opcache.revalidate_freq is ignored when validate_timestamps is 0.
; opcache.revalidate_freq = 60

opcache.fast_shutdown = 1
; New: Enable JIT (Just-In-Time) compilation for an additional CPU-bound performance boost.
opcache.jit_buffer_size=128M
opcache.jit=tracing

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; 3) Realpath Cache (for filesystem lookups)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
realpath_cache_size = 4096k
realpath_cache_ttl = 600

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; 4) Error Logging (donâ€™t display to users, log instead)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
display_errors = Off
log_errors = On
error_log = /var/log/php_errors.log
; New: Set a sensible production error reporting level.
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; 5) Session Security
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
session.gc_maxlifetime = 1440
session.save_handler = files
session.save_path = "/var/lib/php/sessions"
; New: Prevent JavaScript from accessing session cookies (mitigates XSS).
session.cookie_httponly = 1
; New: Only send session cookies over HTTPS. Uncomment if your site uses SSL.
; session.cookie_secure = 1
; New: Helps prevent session fixation attacks.
session.use_strict_mode = 1

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; 6) General Security Hardening (New Section)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; New: Disable for security. Don't reveal your PHP version in HTTP headers.
expose_php = Off
; New: Important for preventing path-related vulnerabilities with FPM.
cgi.fix_pathinfo = 0

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; 7) FPM Pool Settings (edit separately in /etc/php/8.2/fpm/pool.d/www.conf)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Your note is correct, these settings belong in www.conf.
; pm = dynamic
; pm.max_children = 20
; ...
