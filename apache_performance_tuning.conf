# Apache Performance & Hardening - single-file config
# Save this as /etc/apache2/conf-available/performance_tuning.conf
# Then: sudo a2enconf performance_tuning && sudo systemctl reload apache2

###############################################################################
# 1) Core Performance Directives (New Section)
###############################################################################
# New: Disable DNS lookups on client IP addresses. Essential for performance.
HostnameLookups Off

# New: Use the OS's high-performance file sending capabilities.
EnableSendfile On

# New: Accept filters to optimize TCP connections (FreeBSD/Linux specific).
# This allows the kernel to buffer the full request before handing it to Apache.
AcceptFilter http data
AcceptFilter https data

###############################################################################
# 2) MPM (event) tuning - concurrency and threads
###############################################################################
<IfModule mpm_event_module>
    StartServers             2
    MinSpareThreads          25
    MaxSpareThreads          75
    ThreadLimit              64
    ThreadsPerChild          25
    MaxRequestWorkers        150
    MaxConnectionsPerChild   1000
</IfModule>

###############################################################################
# 3) KeepAlive tuning
###############################################################################
KeepAlive On
MaxKeepAliveRequests 100
# Lower timeout reduces idle connections eating worker threads
KeepAliveTimeout 3 # Increased slightly to 3s as a common, balanced value.

###############################################################################
# 4) Compression (mod_deflate)
###############################################################################
<IfModule mod_deflate.c>
    # Compress common text files, adding SVG and fonts.
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml image/svg+xml application/vnd.ms-fontobject application/x-font-ttf font/opentype

    # Avoid compressing already compressed content
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|zip|gz|rar|woff2?)$ no-gzip dont-vary
    Header append Vary User-Agent env=!dont-vary
</IfModule>

###############################################################################
# 5) Expires / Cache headers (mod_expires)
###############################################################################
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 hour"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year" # New
    ExpiresByType image/webp "access plus 1 year" # New
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-font-ttf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year" # New
    ExpiresByType font/woff2 "access plus 1 year" # New
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year" # New
</IfModule>

###############################################################################
# 6) Logging - piped rotatelogs to reduce I/O contention
###############################################################################
CustomLog "|/usr/bin/rotatelogs -l /var/log/apache2/access_log.%Y-%m-%d 86400 14" combined
ErrorLog /var/log/apache2/error.log
LogLevel warn

###############################################################################
# 7) Security headers and server tokens
###############################################################################
ServerSignature Off
ServerTokens Prod
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    # New: Add a Referrer Policy for better privacy/security.
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    # HSTS for HTTPS sites only - enable only when SSL is configured
    # Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
</IfModule>

###############################################################################
# 8) Directory and File Protection
###############################################################################
# New: Add a global block for sensitive files like .htaccess
<Files ".ht*">
    Require all denied
</Files>

<Directory /var/www/>
    Options -Indexes -Includes
    AllowOverride All
    Require all granted
</Directory>

###############################################################################
# 9) Limit Request Methods (New Section)
###############################################################################
# New: Only allow common, required HTTP methods.
<Location />
    <LimitExcept GET POST HEAD>
        deny from all
    </LimitExcept>
</Location>

###############################################################################
# 10) PHP-FPM configuration (recommended over mod_php)
###############################################################################
#<IfModule proxy_fcgi_module>
#    <FilesMatch ".+\.(php|php[0-9])$">
#        SetHandler "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost/"
#    </FilesMatch>
#</IfModule>

# Sections for OS limits, mod_status, and disabling modules are already well-documented in your original file.
# End of performance_tuning.conf
